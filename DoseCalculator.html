<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>Dose Calculator - ToolSuite</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header class="site-header site-header--compact">
      <div class="container header-row">
        <a class="btn btn--ghost" href="index.html">Back</a>
        <div>
          <h1 class="site-header__title">Dose Calculator</h1>
          <p class="site-header__subtitle">Estimate medicine levels using simple half-life decay.</p>
        </div>
      </div>
    </header>

    <main class="container">
      <section class="card">
        <div class="card__header chart-header">
          <div class="chart-header__left">
            <h2 class="card__title">Serum level over <span id="chartDaysLabel">10</span> days</h2>
            <p class="card__subtitle">Assumes 100% bioavailability and doses at the start of each day.</p>
            <div class="chart-header__controls">
              <div class="field-row">
                <div class="field">
                  <label class="field__label" for="halfLife">Half-life</label>
                  <div class="control-row">
                    <input class="input input--sm" type="number" id="halfLife" value="6" min="0.1" step="0.1" />
                    <select class="input input--sm" id="halfLifeUnit" aria-label="Half-life unit">
                      <option value="days" selected>Days</option>
                      <option value="hours">Hours</option>
                    </select>
                  </div>
                </div>
                <div class="field">
                  <label class="field__label" for="modelSelect">Model</label>
                  <select class="input" id="modelSelect">
                    <option value="bolus" selected>Instant (bolus)</option>
                    <option value="bateman">Bateman (SC absorption)</option>
                    <option value="zero">Zero-order absorption</option>
                  </select>
                </div>
              </div>
              <div class="field-row">
                <div class="field" id="modelParamField" hidden>
                  <label class="field__label" for="absorptionValue" id="modelParamLabel">Absorption</label>
                  <div class="control-row">
                    <input class="input input--sm" type="number" id="absorptionValue" value="0.5" min="0.1" step="0.1" />
                    <select class="input input--sm" id="absorptionUnit" aria-label="Absorption unit">
                      <option value="days" selected>Days</option>
                      <option value="hours">Hours</option>
                    </select>
                  </div>
                </div>
                <div class="field">
                  <label class="field__label" for="plotDays">Days in plot</label>
                  <input class="input input--sm" type="number" id="plotDays" value="10" min="1" max="30" step="1" />
                </div>
              </div>
            </div>
          </div>
          <aside class="stats-panel stats-panel--header">
            <h3 class="stats-title">Chart readout</h3>
            <p class="stats-subtitle">Click the chart to see the value at a particular point.</p>
            <div class="stats-selected" id="selectedValue">Click the chart to pin a value.</div>
            <div class="stats-list">
              <div class="stats-row">
                <span>Average</span>
                <span class="stats-value" id="statAvg">--</span>
              </div>
              <div class="stats-row">
                <span>Min</span>
                <span class="stats-value" id="statMin">--</span>
              </div>
              <div class="stats-row">
                <span>Max</span>
                <span class="stats-value" id="statMax">--</span>
              </div>
              <div class="stats-row">
                <span>Std dev</span>
                <span class="stats-value" id="statStd">--</span>
              </div>
            </div>
          </aside>
        </div>

        <div class="chart-area">
          <canvas id="levelChart" class="chart-canvas" role="img" aria-label="Estimated serum level over time"></canvas>
          <div id="chartTooltip" class="chart-tooltip" role="status" aria-live="polite"></div>
        </div>

        <div class="table-section">
          <h3 class="section__title">Dose schedule</h3>
          <p class="section__subtitle">Click a day to set the dose in milligrams.</p>
          <div class="table-wrapper">
            <table class="dose-table" id="doseTable">
              <caption class="table-caption">Doses are applied at the start of each day.</caption>
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
          <div id="dosePopover" class="dose-popover" role="dialog" aria-hidden="true">
            <label class="field__label" for="dosePopoverInput">Dose for <span id="dosePopoverLabel">Day 1</span></label>
            <input class="input dose-popover__input" type="number" id="dosePopoverInput" min="0" step="0.1" />
          </div>
        </div>
      </section>

      <footer class="footer">
        <p class="footer__text">For planning only; not medical advice.</p>
      </footer>
    </main>

    <script>
      const halfLifeInput = document.getElementById("halfLife");
      const halfLifeUnit = document.getElementById("halfLifeUnit");
      const modelSelect = document.getElementById("modelSelect");
      const modelParamField = document.getElementById("modelParamField");
      const modelParamLabel = document.getElementById("modelParamLabel");
      const absorptionValue = document.getElementById("absorptionValue");
      const absorptionUnit = document.getElementById("absorptionUnit");
      const plotDaysInput = document.getElementById("plotDays");
      const chartDaysLabel = document.getElementById("chartDaysLabel");
      const doseTable = document.getElementById("doseTable");
      const doseTableHead = doseTable.querySelector("thead");
      const doseTableBody = doseTable.querySelector("tbody");
      const tableWrapper = document.querySelector(".table-wrapper");
      const dosePopover = document.getElementById("dosePopover");
      const dosePopoverInput = document.getElementById("dosePopoverInput");
      const dosePopoverLabel = document.getElementById("dosePopoverLabel");
      const chart = document.getElementById("levelChart");
      const chartArea = chart.closest(".chart-area");
      const tooltip = document.getElementById("chartTooltip");
      const ctx = chart.getContext("2d");
      const selectedValue = document.getElementById("selectedValue");
      const statAvg = document.getElementById("statAvg");
      const statMin = document.getElementById("statMin");
      const statMax = document.getElementById("statMax");
      const statStd = document.getElementById("statStd");

      const HOURS_PER_DAY = 24;
      const DEFAULT_HALF_LIFE = 6;
      const DEFAULT_PLOT_DAYS = 10;
      const MAX_PLOT_DAYS = 30;
      const DEFAULT_ABSORPTION = 0.5;
      const DAY_LABELS = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
      const chartState = {
        points: [],
        totalHours: 0,
        safeMax: 1,
        avgLevel: 0,
        selectedHour: null,
        padding: null,
        plotWidth: 0,
        plotHeight: 0,
        hasData: false
      };
      let doseValues = [];
      let activeDoseCell = null;
      let activeDoseIndex = null;
      let rafId = null;

      function hideTooltip() {
        if (!tooltip) return;
        tooltip.classList.remove("is-visible");
      }

      function hideDosePopover() {
        if (!dosePopover) return;
        dosePopover.classList.remove("is-visible");
        dosePopover.setAttribute("aria-hidden", "true");
        activeDoseCell = null;
        activeDoseIndex = null;
      }

      function positionDosePopover(target) {
        if (!dosePopover) return;
        const rect = target.getBoundingClientRect();
        const popRect = dosePopover.getBoundingClientRect();
        const padding = 8;
        let left = rect.left + rect.width / 2 - popRect.width / 2;
        left = Math.min(Math.max(left, padding), window.innerWidth - popRect.width - padding);
        let top = rect.bottom + padding;
        if (top + popRect.height > window.innerHeight - padding) {
          top = rect.top - popRect.height - padding;
        }
        top = Math.max(top, padding);
        dosePopover.style.left = `${left}px`;
        dosePopover.style.top = `${top}px`;
      }

      function showDosePopover(target) {
        if (!dosePopover || !dosePopoverInput || !dosePopoverLabel) return;
        activeDoseCell = target;
        const rawIndex = parseInt(target.dataset.dayIndex, 10);
        activeDoseIndex = Number.isFinite(rawIndex) ? rawIndex - 1 : null;
        const dayLabel = target.dataset.dayLabel || `Day ${rawIndex || ""}`.trim();
        dosePopoverLabel.textContent = dayLabel;
        const currentValue =
          activeDoseIndex !== null && Number.isFinite(doseValues[activeDoseIndex])
            ? doseValues[activeDoseIndex]
            : 0;
        dosePopoverInput.value = String(currentValue);
        dosePopoverInput.setAttribute("aria-label", `Dose for ${dayLabel}`);
        dosePopover.classList.add("is-visible");
        dosePopover.setAttribute("aria-hidden", "false");
        positionDosePopover(target);
        dosePopoverInput.focus();
        dosePopoverInput.select();
      }

      function getEventClientPosition(event) {
        if (event.touches && event.touches.length > 0) {
          return { x: event.touches[0].clientX, y: event.touches[0].clientY };
        }
        if (event.changedTouches && event.changedTouches.length > 0) {
          return { x: event.changedTouches[0].clientX, y: event.changedTouches[0].clientY };
        }
        return { x: event.clientX, y: event.clientY };
      }

      function formatMg(value) {
        return `${value.toFixed(2)}mg`;
      }

      function updateStatsDisplay(stats, selectedPoint, hasData) {
        if (!statAvg || !statMin || !statMax || !statStd || !selectedValue) return;
        if (!hasData) {
          statAvg.textContent = "--";
          statMin.textContent = "--";
          statMax.textContent = "--";
          statStd.textContent = "--";
          selectedValue.textContent = "No data yet.";
          return;
        }
        statAvg.textContent = formatMg(stats.avg);
        statMin.textContent = formatMg(stats.min);
        statMax.textContent = formatMg(stats.max);
        statStd.textContent = formatMg(stats.std);
        selectedValue.textContent = selectedPoint
          ? `Day ${Math.floor(selectedPoint.hour / HOURS_PER_DAY) + 1}: ${formatMg(selectedPoint.level)}`
          : "Click the chart to pin a value.";
      }

      function scheduleDraw() {
        if (rafId) return;
        hideTooltip();
        rafId = requestAnimationFrame(() => {
          rafId = null;
          drawChart();
        });
      }

      function getHalfLifeHours() {
        const rawValue = parseFloat(halfLifeInput.value);
        const safeValue = Number.isFinite(rawValue) && rawValue > 0 ? rawValue : DEFAULT_HALF_LIFE;
        if (!Number.isFinite(rawValue) || rawValue <= 0) {
          halfLifeInput.value = String(DEFAULT_HALF_LIFE);
        }
        return halfLifeUnit.value === "hours" ? safeValue : safeValue * HOURS_PER_DAY;
      }

      function getAbsorptionHours() {
        if (!absorptionValue || !absorptionUnit) return DEFAULT_ABSORPTION * HOURS_PER_DAY;
        const rawValue = parseFloat(absorptionValue.value);
        const safeValue = Number.isFinite(rawValue) && rawValue > 0 ? rawValue : DEFAULT_ABSORPTION;
        if (!Number.isFinite(rawValue) || rawValue <= 0) {
          absorptionValue.value = String(DEFAULT_ABSORPTION);
        }
        return absorptionUnit.value === "hours" ? safeValue : safeValue * HOURS_PER_DAY;
      }

      function getPlotDays() {
        const rawValue = parseInt(plotDaysInput.value, 10);
        let safeValue = Number.isFinite(rawValue) ? rawValue : DEFAULT_PLOT_DAYS;
        if (safeValue < 1) {
          safeValue = 1;
        }
        if (safeValue > MAX_PLOT_DAYS) {
          safeValue = MAX_PLOT_DAYS;
        }
        plotDaysInput.value = String(safeValue);
        return safeValue;
      }

      function formatDoseDisplay(value) {
        if (!Number.isFinite(value) || value <= 0) {
          return "0";
        }
        const formatted = value.toFixed(2);
        return formatted.replace(/\.?0+$/, "");
      }

      function updateDoseTableScale(plotDays) {
        if (!doseTable) return;
        const clampedDays = Math.min(Math.max(plotDays, 1), MAX_PLOT_DAYS);
        const rangeStart = 10;
        const rangeEnd = MAX_PLOT_DAYS;
        const t =
          clampedDays <= rangeStart ? 0 : (clampedDays - rangeStart) / (rangeEnd - rangeStart);
        const fontSize = 0.95 - t * 0.3;
        const paddingY = 8 - t * 4;
        const paddingX = 6 - t * 3;
        doseTable.style.setProperty("--dose-font-size", `${fontSize.toFixed(3)}rem`);
        doseTable.style.setProperty("--dose-cell-padding", `${paddingY.toFixed(1)}px ${paddingX.toFixed(1)}px`);
      }

      function renderDoseTable(plotDaysOverride) {
        const plotDays = Number.isFinite(plotDaysOverride) ? plotDaysOverride : getPlotDays();
        if (!Number.isFinite(plotDays) || plotDays < 1) {
          return;
        }
        if (chartDaysLabel) {
          chartDaysLabel.textContent = String(plotDays);
        }
        const existingValues = doseValues.slice();

        doseTableHead.textContent = "";
        doseTableBody.textContent = "";

        const headRow = document.createElement("tr");
        const bodyRow = document.createElement("tr");
        const nextValues = [];

        for (let i = 0; i < plotDays; i++) {
          const dayName = DAY_LABELS[i % DAY_LABELS.length];
          const dayLabel = `${dayName} (Day ${i + 1})`;
          const th = document.createElement("th");
          th.scope = "col";
          th.className = "dose-header";
          th.dataset.dayIndex = String(i + 1);
          th.dataset.dayLabel = dayLabel;
          th.textContent = dayName;
          headRow.appendChild(th);

          const td = document.createElement("td");
          const existingValue = existingValues[i];
          const fallbackValue = i === 0 ? 1 : 0;
          const doseValue = Number.isFinite(existingValue) ? existingValue : fallbackValue;
          nextValues.push(doseValue);
          const button = document.createElement("button");
          button.type = "button";
          button.className = "dose-cell";
          button.dataset.dayIndex = String(i + 1);
          button.dataset.dayName = dayName;
          button.dataset.dayLabel = dayLabel;
          button.setAttribute("aria-label", `Set dose for ${dayLabel}`);
          button.textContent = formatDoseDisplay(doseValue);
          td.appendChild(button);
          bodyRow.appendChild(td);
        }

        doseTableHead.appendChild(headRow);
        doseTableBody.appendChild(bodyRow);
        doseValues = nextValues;
        chartState.selectedHour = null;
        hideDosePopover();
        updateDoseTableScale(plotDays);
      }

      function getDoses() {
        return doseValues.map((value) => (Number.isFinite(value) && value > 0 ? value : 0));
      }

      function updateModelControls() {
        if (!modelSelect || !modelParamField || !modelParamLabel) return;
        const model = modelSelect.value;
        if (model === "bolus") {
          modelParamField.hidden = true;
          modelParamField.setAttribute("aria-hidden", "true");
          if (absorptionValue) absorptionValue.disabled = true;
          if (absorptionUnit) absorptionUnit.disabled = true;
          modelParamField.classList.add("is-disabled");
          return;
        }
        modelParamField.hidden = false;
        modelParamField.setAttribute("aria-hidden", "false");
        if (absorptionValue) absorptionValue.disabled = false;
        if (absorptionUnit) absorptionUnit.disabled = false;
        modelParamField.classList.remove("is-disabled");
        modelParamLabel.textContent =
          model === "bateman" ? "Absorption half-life" : "Absorption duration";
      }

      function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = chart.getBoundingClientRect();
        const width = Math.max(1, rect.width);
        const height = Math.max(1, rect.height);
        chart.width = Math.round(width * dpr);
        chart.height = Math.round(height * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        return { width, height };
      }

      function getThemeColors() {
        const styles = getComputedStyle(document.documentElement);
        return {
          surface: styles.getPropertyValue("--surface").trim() || "#ffffff",
          border: styles.getPropertyValue("--border").trim() || "#d8dee9",
          primary: styles.getPropertyValue("--primary").trim() || "#2563eb",
          muted: styles.getPropertyValue("--muted").trim() || "#475569"
        };
      }

      function computePoints(halfLifeHours, doses, model, absorptionHours) {
        const totalDays = doses.length;
        const totalHours = totalDays * HOURS_PER_DAY;
        const stepHours = 1;
        const points = [];
        const ke = Math.log(2) / halfLifeHours;
        const safeAbsorption = Math.max(absorptionHours, 0.01);
        const ka = Math.log(2) / safeAbsorption;

        for (let hour = 0; hour <= totalHours; hour += stepHours) {
          let level = 0;
          for (let day = 0; day < totalDays; day++) {
            const dose = doses[day];
            if (dose <= 0) continue;
            const doseHour = day * HOURS_PER_DAY;
            if (hour >= doseHour) {
              const t = hour - doseHour;
              if (model === "bateman") {
                if (Math.abs(ka - ke) < 1e-6) {
                  level += dose * ke * t * Math.exp(-ke * t);
                } else {
                  level += (dose * ka * (Math.exp(-ke * t) - Math.exp(-ka * t))) / (ka - ke);
                }
              } else if (model === "zero") {
                const duration = safeAbsorption;
                const rate = dose / duration;
                if (t <= duration) {
                  level += (rate / ke) * (1 - Math.exp(-ke * t));
                } else {
                  level += (rate / ke) * (1 - Math.exp(-ke * duration)) * Math.exp(-ke * (t - duration));
                }
              } else {
                level += dose * Math.exp(-ke * t);
              }
            }
          }
          points.push({ hour, level });
        }

        return { points, totalHours };
      }

      function computeStats(points) {
        if (!points.length) {
          return {
            avg: 0,
            min: 0,
            max: 0,
            std: 0
          };
        }
        let sum = 0;
        let min = Infinity;
        let max = -Infinity;
        points.forEach((point) => {
          sum += point.level;
          if (point.level < min) min = point.level;
          if (point.level > max) max = point.level;
        });
        const avg = sum / points.length;
        let variance = 0;
        points.forEach((point) => {
          variance += (point.level - avg) ** 2;
        });
        const std = Math.sqrt(variance / points.length);
        return { avg, min, max, std };
      }

      function drawAxisLabels(width, height, padding, plotWidth, plotHeight, colors) {
        ctx.save();
        ctx.fillStyle = colors.muted;
        ctx.font =
          "12px system-ui, -apple-system, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "alphabetic";
        ctx.fillText("Days", padding.left + plotWidth / 2, height - 6);
        ctx.translate(12, padding.top + plotHeight / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.textBaseline = "middle";
        ctx.fillText("Level (mg)", 0, 0);
        ctx.restore();
      }

      function positionTooltip(x, y, label) {
        if (!tooltip || !chartArea) return;
        tooltip.textContent = label;
        const areaWidth = chartArea.clientWidth;
        const areaHeight = chartArea.clientHeight;
        const tooltipWidth = tooltip.offsetWidth;
        const tooltipHeight = tooltip.offsetHeight;
        const minLeft = tooltipWidth / 2 + 8;
        const maxLeft = areaWidth - tooltipWidth / 2 - 8;
        const minTop = tooltipHeight + 12;
        let left = Math.min(Math.max(x, minLeft), maxLeft);
        let top = Math.max(y, minTop);
        top = Math.min(top, areaHeight - 8);
        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${top}px`;
        tooltip.classList.add("is-visible");
      }

      function handleHover(event) {
        if (!chartState.hasData || !tooltip) return;
        const rect = chart.getBoundingClientRect();
        const position = getEventClientPosition(event);
        const x = position.x - rect.left;
        const y = position.y - rect.top;
        const { padding, plotWidth, plotHeight, totalHours, points, safeMax, avgLevel } = chartState;
        if (
          x < padding.left ||
          x > padding.left + plotWidth ||
          y < padding.top ||
          y > padding.top + plotHeight
        ) {
          hideTooltip();
          return;
        }

        if (avgLevel > 0) {
          const avgY = padding.top + plotHeight - (avgLevel / safeMax) * plotHeight;
          if (Math.abs(y - avgY) <= 6) {
            positionTooltip(x, avgY, `Average: ${avgLevel.toFixed(2)}mg`);
            return;
          }
        }

        const hour = Math.round(((x - padding.left) / plotWidth) * totalHours);
        const index = Math.min(Math.max(hour, 0), points.length - 1);
        const point = points[index];
        if (!point || point.level <= 0) {
          hideTooltip();
          return;
        }

        const levelX = padding.left + (point.hour / totalHours) * plotWidth;
        const levelY = padding.top + plotHeight - (point.level / safeMax) * plotHeight;
        const dayNumber = Math.floor(point.hour / HOURS_PER_DAY) + 1;
        positionTooltip(levelX, levelY, `Day ${dayNumber}: ${point.level.toFixed(2)}mg`);
      }

      function handleClick(event) {
        if (!chartState.hasData) return;
        const rect = chart.getBoundingClientRect();
        const position = getEventClientPosition(event);
        const x = position.x - rect.left;
        const y = position.y - rect.top;
        const { padding, plotWidth, plotHeight, totalHours, points } = chartState;
        if (
          x < padding.left ||
          x > padding.left + plotWidth ||
          y < padding.top ||
          y > padding.top + plotHeight
        ) {
          return;
        }

        const hour = Math.round(((x - padding.left) / plotWidth) * totalHours);
        const index = Math.min(Math.max(hour, 0), points.length - 1);
        chartState.selectedHour = points[index].hour;
        scheduleDraw();
      }

      function handleTouch(event) {
        event.preventDefault();
        handleHover(event);
      }

      function handleTouchEnd(event) {
        handleClick(event);
        hideTooltip();
      }

      function drawChart() {
        if (!chart) return;
        const { width, height } = resizeCanvas();
        const colors = getThemeColors();
        const padding = { top: 16, right: 16, bottom: 24, left: 36 };
        const plotWidth = Math.max(1, width - padding.left - padding.right);
        const plotHeight = Math.max(1, height - padding.top - padding.bottom);

        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = colors.surface;
        ctx.fillRect(0, 0, width, height);

        const halfLifeHours = getHalfLifeHours();
        const model = modelSelect ? modelSelect.value : "bolus";
        const absorptionHours = getAbsorptionHours();
        const doses = getDoses();
        const totalDays = doses.length;
        const { points, totalHours } = computePoints(halfLifeHours, doses, model, absorptionHours);
        const stats = computeStats(points);
        const maxLevel = stats.max;
        const safeMax = maxLevel > 0 ? maxLevel : 1;
        const avgLevel = stats.avg;
        let selectedPoint = null;
        if (chartState.selectedHour !== null && points.length > 0) {
          const index = Math.min(Math.max(chartState.selectedHour, 0), points.length - 1);
          selectedPoint = points[index];
        }
        chartState.points = points;
        chartState.totalHours = totalHours;
        chartState.safeMax = safeMax;
        chartState.avgLevel = avgLevel;
        chartState.selectedPoint = selectedPoint;
        chartState.padding = padding;
        chartState.plotWidth = plotWidth;
        chartState.plotHeight = plotHeight;
        chartState.hasData = maxLevel > 0;
        updateStatsDisplay(stats, selectedPoint, chartState.hasData);

        ctx.lineWidth = 1;
        ctx.strokeStyle = colors.border;
        ctx.globalAlpha = 0.35;

        for (let i = 0; i <= 4; i++) {
          const y = padding.top + (plotHeight * i) / 4;
          ctx.beginPath();
          ctx.moveTo(padding.left, y);
          ctx.lineTo(padding.left + plotWidth, y);
          ctx.stroke();
        }

        for (let day = 0; day <= totalDays; day++) {
          const x = padding.left + (plotWidth * day) / totalDays;
          ctx.beginPath();
          ctx.moveTo(x, padding.top);
          ctx.lineTo(x, padding.top + plotHeight);
          ctx.stroke();
        }

        ctx.globalAlpha = 1;
        drawAxisLabels(width, height, padding, plotWidth, plotHeight, colors);

        if (maxLevel === 0) {
          ctx.fillStyle = colors.muted;
          ctx.font =
            "13px system-ui, -apple-system, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif";
          ctx.textAlign = "center";
          ctx.fillText("Enter a dose to see the curve", width / 2, height / 2);
          hideTooltip();
          return;
        }

        ctx.beginPath();
        points.forEach((point, index) => {
          const x = padding.left + (point.hour / totalHours) * plotWidth;
          const y = padding.top + plotHeight - (point.level / safeMax) * plotHeight;
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.lineTo(padding.left + plotWidth, padding.top + plotHeight);
        ctx.lineTo(padding.left, padding.top + plotHeight);
        ctx.closePath();
        ctx.fillStyle = colors.primary;
        ctx.globalAlpha = 0.15;
        ctx.fill();
        ctx.globalAlpha = 1;

        ctx.beginPath();
        points.forEach((point, index) => {
          const x = padding.left + (point.hour / totalHours) * plotWidth;
          const y = padding.top + plotHeight - (point.level / safeMax) * plotHeight;
          if (index === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        });
        ctx.strokeStyle = colors.primary;
        ctx.lineWidth = 2;
        ctx.stroke();

        if (avgLevel > 0) {
          const avgY = padding.top + plotHeight - (avgLevel / safeMax) * plotHeight;
          ctx.save();
          ctx.strokeStyle = colors.muted;
          ctx.lineWidth = 1.5;
          ctx.globalAlpha = 0.7;
          ctx.setLineDash([6, 6]);
          ctx.beginPath();
          ctx.moveTo(padding.left, avgY);
          ctx.lineTo(padding.left + plotWidth, avgY);
          ctx.stroke();
          ctx.restore();
        }

        if (selectedPoint) {
          const markerX = padding.left + (selectedPoint.hour / totalHours) * plotWidth;
          const markerY = padding.top + plotHeight - (selectedPoint.level / safeMax) * plotHeight;
          ctx.save();
          ctx.fillStyle = colors.primary;
          ctx.strokeStyle = colors.surface;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(markerX, markerY, 4, 0, Math.PI * 2);
          ctx.fill();
          ctx.stroke();
          ctx.restore();
        }
      }

      renderDoseTable();
      if (tableWrapper) {
        tableWrapper.addEventListener("click", (event) => {
          const header = event.target.closest(".dose-header");
          if (header) {
            const rawIndex = parseInt(header.dataset.dayIndex, 10);
            const row = doseTableBody.querySelector("tr");
            const cell = Number.isFinite(rawIndex) ? row?.children[rawIndex - 1] : null;
            const button = cell?.querySelector(".dose-cell");
            if (button) {
              showDosePopover(button);
            }
            return;
          }
          const cell = event.target.closest(".dose-cell");
          if (cell) {
            showDosePopover(cell);
          }
        });
        tableWrapper.addEventListener("focusin", (event) => {
          const target = event.target;
          if (target.classList.contains("dose-cell")) {
            showDosePopover(target);
          }
        });
      }
      if (dosePopoverInput) {
        dosePopoverInput.addEventListener("input", () => {
          if (activeDoseIndex === null || !Number.isFinite(activeDoseIndex)) return;
          const rawValue = parseFloat(dosePopoverInput.value);
          if (!Number.isFinite(rawValue)) return;
          const safeValue = Math.max(rawValue, 0);
          doseValues[activeDoseIndex] = safeValue;
          if (activeDoseCell) {
            activeDoseCell.textContent = formatDoseDisplay(safeValue);
          }
          scheduleDraw();
        });
        dosePopoverInput.addEventListener("keydown", (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            const rawValue = parseFloat(dosePopoverInput.value);
            const safeValue = Number.isFinite(rawValue) ? Math.max(rawValue, 0) : 0;
            if (activeDoseIndex !== null && Number.isFinite(activeDoseIndex)) {
              doseValues[activeDoseIndex] = safeValue;
              if (activeDoseCell) {
                activeDoseCell.textContent = formatDoseDisplay(safeValue);
              }
            }
            hideDosePopover();
            scheduleDraw();
          }
          if (event.key === "Escape") {
            event.preventDefault();
            hideDosePopover();
          }
        });
      }
      plotDaysInput.addEventListener("input", () => {
        const rawValue = parseInt(plotDaysInput.value, 10);
        if (!Number.isFinite(rawValue) || rawValue < 1 || rawValue > MAX_PLOT_DAYS) {
          return;
        }
        renderDoseTable(rawValue);
        scheduleDraw();
      });
      plotDaysInput.addEventListener("change", () => {
        renderDoseTable();
        scheduleDraw();
      });
      if (modelSelect) {
        modelSelect.addEventListener("change", () => {
          updateModelControls();
          scheduleDraw();
        });
      }
      if (absorptionValue) {
        absorptionValue.addEventListener("input", scheduleDraw);
      }
      if (absorptionUnit) {
        absorptionUnit.addEventListener("change", scheduleDraw);
      }
      halfLifeInput.addEventListener("input", scheduleDraw);
      halfLifeUnit.addEventListener("change", scheduleDraw);
      chart.addEventListener("mousemove", handleHover);
      chart.addEventListener("click", handleClick);
      chart.addEventListener("mouseleave", hideTooltip);
      chart.addEventListener("touchstart", handleTouch, { passive: false });
      chart.addEventListener("touchmove", handleTouch, { passive: false });
      chart.addEventListener("touchend", handleTouchEnd);
      chart.addEventListener("touchcancel", handleTouchEnd);
      window.addEventListener("resize", scheduleDraw);
      window.addEventListener("resize", () => {
        if (activeDoseCell) {
          positionDosePopover(activeDoseCell);
        }
      });
      document.addEventListener("pointerdown", (event) => {
        if (!dosePopover || !dosePopover.classList.contains("is-visible")) return;
        if (dosePopover.contains(event.target)) return;
        if (event.target.closest(".dose-cell")) return;
        hideDosePopover();
      });

      if (window.matchMedia) {
        const schemeQuery = window.matchMedia("(prefers-color-scheme: dark)");
        if (schemeQuery.addEventListener) {
          schemeQuery.addEventListener("change", scheduleDraw);
        } else if (schemeQuery.addListener) {
          schemeQuery.addListener(scheduleDraw);
        }
      }

      updateModelControls();
      scheduleDraw();
    </script>
  </body>
</html>
